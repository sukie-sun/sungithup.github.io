<!DOCTYPE html>
<html lang="zh-Hans">
<head><meta name="generator" content="Hexo 3.8.0">

    <!--[if lt IE 9]>
        <style>body {display: none; background: none !important} </style>
        <meta http-equiv="Refresh" Content="0; url=//outdatedbrowser.com/" />
    <![endif]-->

<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge, chrome=1">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<meta name="format-detection" content="telephone=no">
<meta name="author" content="Sukie">



<meta name="description" content="Spark学习第三篇章：案例学习">
<meta name="keywords" content="计算框架,参数解释,Spark shell">
<meta property="og:type" content="article">
<meta property="og:title" content="Spark学习（三）">
<meta property="og:url" content="http://sungithup.github.io/2019/02/18/Spark学习（三）/index.html">
<meta property="og:site_name" content="Sukie山脉">
<meta property="og:description" content="Spark学习第三篇章：案例学习">
<meta property="og:locale" content="zh-Hans">
<meta property="og:image" content="https://ws1.sinaimg.cn/large/005zftzDgy1g0d8nkvqzrj310k06zmxl.jpg">
<meta property="og:image" content="https://ws1.sinaimg.cn/large/005zftzDgy1g0d8r7qsrzj30q50apwgd.jpg">
<meta property="og:image" content="https://ws1.sinaimg.cn/large/005zftzDgy1g0d8t4eeftj30xj079go4.jpg">
<meta property="og:image" content="https://ws1.sinaimg.cn/large/005zftzDgy1g0d8unf1yfj30gn0beac3.jpg">
<meta property="og:image" content="http://node00:8080/static/spark-logo-77x50px-hd.png">
<meta property="og:image" content="http://node01:8080/static/spark-logo-77x50px-hd.png">
<meta property="og:updated_time" content="2019-02-22T01:56:24.028Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Spark学习（三）">
<meta name="twitter:description" content="Spark学习第三篇章：案例学习">
<meta name="twitter:image" content="https://ws1.sinaimg.cn/large/005zftzDgy1g0d8nkvqzrj310k06zmxl.jpg">

<link rel="apple-touch-icon" href="/apple-touch-icon.png">


    <link rel="alternate" href="/atom.xml" title="Sukie山脉" type="application/atom+xml">



    <link rel="shortcut icon" href="/favicon.png">



    <link href="//cdn.bootcss.com/animate.css/3.5.1/animate.min.css" rel="stylesheet">



    <link href="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.min.css" rel="stylesheet">



    <script src="//cdn.bootcss.com/pace/1.0.2/pace.min.js"></script>
    <link href="//cdn.bootcss.com/pace/1.0.2/themes/blue/pace-theme-minimal.css" rel="stylesheet">


<link rel="stylesheet" href="/css/style.css">



<link href="//cdn.bootcss.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet">


<title>Spark学习（三） | Sukie山脉</title>

<script src="//cdn.bootcss.com/jquery/2.2.4/jquery.min.js"></script>
<script src="//cdn.bootcss.com/clipboard.js/1.5.10/clipboard.min.js"></script>

<script>
    var yiliaConfig = {
        fancybox: true,
        animate: true,
        isHome: false,
        isPost: true,
        isArchive: false,
        isTag: false,
        isCategory: false,
        fancybox_js: "//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.min.js",
        scrollreveal: "//cdn.bootcss.com/scrollReveal.js/3.1.4/scrollreveal.min.js",
        search: true
    }
</script>


    <script>
        yiliaConfig.jquery_ui = [true, "//cdn.bootcss.com/jqueryui/1.10.4/jquery-ui.min.js", "//cdn.bootcss.com/jqueryui/1.10.4/css/jquery-ui.min.css"];
    </script>



    <script> yiliaConfig.rootUrl = "\/";</script>





    <script>
        var _hmt = _hmt || [];
        (function() {
            var hm = document.createElement("script");
            hm.src = "//hm.baidu.com/hm.js?bc39ced90d9f89c71fda7b7d4ca8b638";
            var s = document.getElementsByTagName("script")[0]; 
            s.parentNode.insertBefore(hm, s);
        })();
    </script>


</head></html>
<body>
  <div id="container">
    <div class="left-col">
    <div class="overlay"></div>
<div class="intrude-less">
    <header id="header" class="inner">
        <a href="/" class="profilepic">
            <img src="/img/avatar.png" class="animated zoomIn">
        </a>
        <hgroup>
          <h1 class="header-author"><a href="/">Sukie</a></h1>
        </hgroup>

        
        <p class="header-subtitle">肆意玩耍，肆意高歌</p>
        

        
            <form id="search-form">
            <input type="text" id="local-search-input" name="q" placeholder="search..." class="search form-control" autocomplete="off" autocorrect="off" searchonload="false">
            <i class="fa fa-times" onclick="resetSearch()"></i>
            </form>
            <div id="local-search-result"></div>
            <p class="no-result">No results found <i class="fa fa-spinner fa-pulse"></i></p>
        


        
            <div id="switch-btn" class="switch-btn">
                <div class="icon">
                    <div class="icon-ctn">
                        <div class="icon-wrap icon-house" data-idx="0">
                            <div class="birdhouse"></div>
                            <div class="birdhouse_holes"></div>
                        </div>
                        <div class="icon-wrap icon-ribbon hide" data-idx="1">
                            <div class="ribbon"></div>
                        </div>
                        
                        <div class="icon-wrap icon-link hide" data-idx="2">
                            <div class="loopback_l"></div>
                            <div class="loopback_r"></div>
                        </div>
                        
                        
                        <div class="icon-wrap icon-me hide" data-idx="3">
                            <div class="user"></div>
                            <div class="shoulder"></div>
                        </div>
                        
                    </div>
                    
                </div>
                <div class="tips-box hide">
                    <div class="tips-arrow"></div>
                    <ul class="tips-inner">
                        <li>菜单</li>
                        <li>标签</li>
                        
                        <li>友情链接</li>
                        
                        
                        <li>关于我</li>
                        
                    </ul>
                </div>
            </div>
        

        <div id="switch-area" class="switch-area">
            <div class="switch-wrap">
                <section class="switch-part switch-part1">
                    <nav class="header-menu">
                        <ul>
                        
                            <li><a href="/">主页</a></li>
                        
                            <li><a href="/archives/">所有文章</a></li>
                        
                            <li><a href="/tags/essays/">推荐</a></li>
                        
                            <li><a href="/books/">书籍</a></li>
                        
                            <li><a href="/tags/">标签云</a></li>
                        
                            <li><a href="/about/">关于我</a></li>
                        
                        </ul>
                    </nav>
                    <nav class="header-nav">
                        <ul class="social">
                            
                                <a class="fa Email" href="mailto:sunyaru216@163.com" title="Email"></a>
                            
                                <a class="fa 新浪微博" href="http://weibo.com/sunrise200 " title="新浪微博"></a>
                            
                                <a class="fa GitHub" href="https://github.com/sungithup" title="GitHub"></a>
                            
                                <a class="fa RSS" href="/atom.xml" title="RSS"></a>
                            
                                <a class="fa 博客园" href="/cnblogs" title="博客园"></a>
                            
                                <a class="fa CSDN" href="/" title="CSDN"></a>
                            
                                <a class="fa 网易云音乐" href="https://music.163.com/#/song?id=18949687" title="网易云音乐"></a>
                            
                        </ul>
                    </nav>
                </section>
                
                
                <section class="switch-part switch-part2">
                    <div class="widget tagcloud" id="js-tagcloud">
                        <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/Array/">Array</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/CentOS-6/">CentOS 6</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/HBase/">HBase</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/HDFS/">HDFS</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Hive/">Hive</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/JVM/">JVM</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Linux命令/">Linux命令</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Linux系统环境/">Linux系统环境</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/List/">List</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Map/">Map</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/MapReduce/">MapReduce</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Nginx/">Nginx</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Redis/">Redis</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Set/">Set</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Spark-shell/">Spark shell</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/SparkStreaming/">SparkStreaming</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Spark框架/">Spark框架</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Storm，流式处理框架/">Storm，流式处理框架</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/String/">String</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Zookeeper/">Zookeeper</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/flume/">flume</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/github/">github</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/hadoop/">hadoop</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/maven/">maven</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/yarn/">yarn</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/分而治之/">分而治之</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/参数解释/">参数解释</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/广播/">广播</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/流式处理框架/">流式处理框架</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/系统学习/">系统学习</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/累加器/">累加器</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/编程语言/">编程语言</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/计算引擎/">计算引擎</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/计算框架/">计算框架</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/负载均衡/">负载均衡</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/静态/">静态</a></li></ul>
                    </div>
                </section>
                
                
                
                <section class="switch-part switch-part3">
                    <div id="js-friends">
                    
                      <a class="main-nav-link switch-friends-link" href="https://hexo.io">Hexo</a>
                    
                      <a class="main-nav-link switch-friends-link" href="https://pages.github.com/">GitHub</a>
                    
                      <a class="main-nav-link switch-friends-link" href="http://moxfive.xyz/">MOxFIVE</a>
                    
                    </div>
                </section>
                

                
                
                <section class="switch-part switch-part4">
                
                    <div id="js-aboutme">正宗小白</div>
                </section>
                
            </div>
        </div>
    </header>                
</div>
    </div>
    <div class="mid-col">
      <nav id="mobile-nav">
      <div class="overlay">
          <div class="slider-trigger"></div>
          <h1 class="header-author js-mobile-header hide"><a href="/" title="回到主页">Sukie</a></h1>
      </div>
    <div class="intrude-less">
        <header id="header" class="inner">
            <a href="/" class="profilepic">
                <img src="/img/avatar.png" class="animated zoomIn">
            </a>
            <hgroup>
              <h1 class="header-author"><a href="/" title="回到主页">Sukie</a></h1>
            </hgroup>
            
            <p class="header-subtitle">肆意玩耍，肆意高歌</p>
            
            <nav class="header-menu">
                <ul>
                
                    <li><a href="/">主页</a></li>
                
                    <li><a href="/archives/">所有文章</a></li>
                
                    <li><a href="/tags/essays/">推荐</a></li>
                
                    <li><a href="/books/">书籍</a></li>
                
                    <li><a href="/tags/">标签云</a></li>
                
                    <li><a href="/about/">关于我</a></li>
                
                <div class="clearfix"></div>
                </ul>
            </nav>
            <nav class="header-nav">
                        <ul class="social">
                            
                                <a class="fa Email" target="_blank" href="mailto:sunyaru216@163.com" title="Email"></a>
                            
                                <a class="fa 新浪微博" target="_blank" href="http://weibo.com/sunrise200 " title="新浪微博"></a>
                            
                                <a class="fa GitHub" target="_blank" href="https://github.com/sungithup" title="GitHub"></a>
                            
                                <a class="fa RSS" target="_blank" href="/atom.xml" title="RSS"></a>
                            
                                <a class="fa 博客园" target="_blank" href="/cnblogs" title="博客园"></a>
                            
                                <a class="fa CSDN" target="_blank" href="/" title="CSDN"></a>
                            
                                <a class="fa 网易云音乐" target="_blank" href="https://music.163.com/#/song?id=18949687" title="网易云音乐"></a>
                            
                        </ul>
            </nav>
        </header>                
    </div>
    <link class="menu-list" tags="标签" friends="友情链接" about="关于我">
</nav>
      <div class="body-wrap"><article id="post-Spark学习（三）" class="article article-type-post" itemscope="" itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2019/02/18/Spark学习（三）/" class="article-date">
      <time datetime="2019-02-17T16:00:00.000Z" itemprop="datePublished">2019-02-18</time>
</a>


    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      Spark学习（三）
    </h1>
  

        
           <div style="margin-top:10px;"> 
     <span class="post-time"> 
           <span class="post-meta-item-icon"> 
                 <i class="fa fa-keyboard-o"></i> 
                 <span class="post-meta-item-text"> 字数统计: </span> 
                 <span class="post-count">5k字</span> 
           </span>
     </span> 

     <span class="post-time">
           |   
           <span class="post-meta-item-icon"> 
                 <i class="fa fa-hourglass-half"></i> 
                 <span class="post-meta-item-text"> 阅读时长: </span> 
                 <span class="post-count">27分</span> 
           </span> 
     </span> 
</div>

           
      </header>     
      
      <div class="article-info article-info-post">
        
    <div class="article-category tagcloud">
    <a class="article-category-link" href="/categories/Spark/">Spark</a>
    </div>


        
    <div class="article-tag tagcloud">
        <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Spark-shell/">Spark shell</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/参数解释/">参数解释</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/计算框架/">计算框架</a></li></ul>
    </div>

        <div class="clearfix"></div>
      </div>
      
    
    <div class="article-entry" itemprop="articleBody">
      
          
        <h1 id="案例一、统计网站-pv-和-uv统计"><a href="#案例一、统计网站-pv-和-uv统计" class="headerlink" title="案例一、统计网站 pv 和 uv统计"></a>案例一、统计网站 pv 和 uv统计</h1><h2 id="0、概念理解"><a href="#0、概念理解" class="headerlink" title="0、概念理解"></a>0、概念理解</h2><p><code>PV</code> 是网站分析的一个术语，用以衡量网站用户访问的网页的数量。</p>
<p>对于广告主，PV 值可预期它可以带来多少广告收入。一般来说，PV 与来访者的数量成正比，但是 PV 并不直接决定页面的真实来访者数量，如同一个来访者通过不断的刷新页面，也可以制造出非常高的 PV。</p>
<h2 id="1、什么是-PV-值"><a href="#1、什么是-PV-值" class="headerlink" title="1、什么是 PV 值"></a>1、什么是 PV 值</h2><p>PV （page view ）即页面浏览量或点击量，是衡量一个网站或网页用户访问量。</p>
<p>PV 值就是所有访问者在 24 小时（0 点到 24 点）内看了某个网站多少个页面或某个网页多少次。</p>
<p>PV 是指页面刷新的次数，每一次页面刷新，就算做一次 PV 流量。</p>
<h2 id="2、什么是UV-值"><a href="#2、什么是UV-值" class="headerlink" title="2、什么是UV 值"></a>2、什么是UV 值</h2><p>UV （unique visitor ）即独立访客数，指访问某个站点或点击某个网页的不同 IP 地址的人数。</p>
<p>在同一天内，UV  只记录第一次进入网站的具有独立IP  的访问者，在同一天内再次访问该网站则不计数。</p>
<p>UV 提供了一定时间内不同观众数量的统计指标，而没有反应出网站的全面活动。</p>
<p><code>PV</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.bd.java.core;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.spark.SparkConf;</span><br><span class="line"><span class="keyword">import</span> org.apache.spark.api.java.JavaPairRDD;</span><br><span class="line"><span class="keyword">import</span> org.apache.spark.api.java.JavaRDD;</span><br><span class="line"><span class="keyword">import</span> org.apache.spark.api.java.JavaSparkContext;</span><br><span class="line"><span class="keyword">import</span> org.apache.spark.api.java.function.Function2;</span><br><span class="line"><span class="keyword">import</span> org.apache.spark.api.java.function.PairFunction;</span><br><span class="line"><span class="keyword">import</span> org.apache.spark.api.java.function.VoidFunction;</span><br><span class="line"><span class="keyword">import</span> org.apache.spark.deploy.master.Master;</span><br><span class="line"><span class="keyword">import</span> scala.Tuple2;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Iterator;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestPV</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        SparkConf sparkConf = <span class="keyword">new</span> SparkConf();</span><br><span class="line">        sparkConf.setMaster(<span class="string">"local"</span>).setAppName(<span class="string">"pv"</span>);</span><br><span class="line">        JavaSparkContext context = <span class="keyword">new</span> JavaSparkContext(sparkConf);</span><br><span class="line"></span><br><span class="line">        JavaRDD&lt;String&gt; lineRDD = context.textFile(<span class="string">"./data/pvuvdata"</span>);</span><br><span class="line">        <span class="comment">/**求每个页面 PV</span></span><br><span class="line"><span class="comment">         * 文件每一行的内容</span></span><br><span class="line"><span class="comment">115.77.12.186	安徽	2017-10-10	1512012307084	5641635304912151098	www.suning.com</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="comment">//方法一：mapToPair().reduceByKey().foeach()</span></span><br><span class="line">     lineRDD.mapToPair(<span class="keyword">new</span> PairFunction&lt;String, String, Integer&gt;() &#123;</span><br><span class="line">      <span class="meta">@Override</span></span><br><span class="line">      <span class="function"><span class="keyword">public</span> Tuple2&lt;String, Integer&gt; <span class="title">call</span><span class="params">(String line)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">               String[] str = line.split(<span class="string">"\t"</span>);</span><br><span class="line">               <span class="keyword">return</span> <span class="keyword">new</span> Tuple2&lt;&gt;(str[<span class="number">5</span>],<span class="number">1</span>);</span><br><span class="line">            &#125;</span><br><span class="line">       &#125;).reduceByKey(<span class="keyword">new</span> Function2&lt;Integer, Integer, Integer&gt;() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">           <span class="function"><span class="keyword">public</span> Integer <span class="title">call</span><span class="params">(Integer v1, Integer v2)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">                   <span class="keyword">return</span> v1 + v2;</span><br><span class="line">           &#125;</span><br><span class="line">      &#125;).foreach(<span class="keyword">new</span> VoidFunction&lt;Tuple2&lt;String, Integer&gt;&gt;() &#123;</span><br><span class="line">           <span class="meta">@Override</span></span><br><span class="line">           <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">call</span><span class="params">(Tuple2&lt;String, Integer&gt; tuple2)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">               System.out.println(tuple2);</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;);</span><br><span class="line">          <span class="comment">//方法二:  mapToPair().groupByKey().foeach()</span></span><br><span class="line">     JavaPairRDD&lt;String, Iterable&lt;Integer&gt;&gt; groupByKeyRDD =                               lineRDD.mapToPair(<span class="keyword">new</span> PairFunction&lt;String, String, Integer&gt;() &#123;</span><br><span class="line">           <span class="meta">@Override</span></span><br><span class="line">          <span class="function"><span class="keyword">public</span> Tuple2&lt;String, Integer&gt; <span class="title">call</span><span class="params">(String line)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">               String[] str = line.split(<span class="string">"\t"</span>);</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">new</span> Tuple2&lt;&gt;(str[<span class="number">5</span>], <span class="number">1</span>);</span><br><span class="line">           &#125;</span><br><span class="line">      &#125;).groupByKey();</span><br><span class="line"></span><br><span class="line">    groupByKeyRDD.foreach(<span class="keyword">new</span> VoidFunction&lt;Tuple2&lt;String, Iterable&lt;Integer&gt;&gt;&gt;() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">     <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">call</span><span class="params">(Tuple2&lt;String, Iterable&lt;Integer&gt;&gt; tuple2)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">               <span class="keyword">int</span> count = <span class="number">0</span>;</span><br><span class="line">               Iterator&lt;Integer&gt; iterator = tuple2._2.iterator();</span><br><span class="line">                <span class="keyword">while</span>(iterator.hasNext())&#123;</span><br><span class="line">                   count++;</span><br><span class="line">               &#125;</span><br><span class="line">               System.out.println(<span class="string">"url : "</span> + tuple2._1 + <span class="string">" value: "</span> + count);</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;);  </span><br><span class="line">           <span class="comment">//方法三： mapToPair().countByKey()--&gt;对map遍历</span></span><br><span class="line">    Map&lt;String, Object&gt; map = </span><br><span class="line">        lineRDD.mapToPair(<span class="keyword">new</span> PairFunction&lt;String, String, Integer&gt;() &#123;</span><br><span class="line">           <span class="meta">@Override</span></span><br><span class="line">           <span class="function"><span class="keyword">public</span> Tuple2&lt;String, Integer&gt; <span class="title">call</span><span class="params">(String line)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">               String[] str = line.split(<span class="string">"\t"</span>);</span><br><span class="line">               <span class="comment">// url,1</span></span><br><span class="line">               <span class="keyword">return</span> <span class="keyword">new</span> Tuple2&lt;&gt;(str[<span class="number">5</span>], <span class="number">1</span>);</span><br><span class="line">            &#125;</span><br><span class="line">       &#125;).countByKey();</span><br><span class="line">       <span class="keyword">for</span> (String key :map.keySet())&#123;</span><br><span class="line">           System.out.println(<span class="string">"key : "</span> + key  + <span class="string">"   value :"</span> + map.get(key) );</span><br><span class="line">       &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>UV</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.bd.java.core;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.spark.SparkConf;</span><br><span class="line"><span class="keyword">import</span> org.apache.spark.api.java.JavaPairRDD;</span><br><span class="line"><span class="keyword">import</span> org.apache.spark.api.java.JavaRDD;</span><br><span class="line"><span class="keyword">import</span> org.apache.spark.api.java.JavaSparkContext;</span><br><span class="line"><span class="keyword">import</span> org.apache.spark.api.java.function.PairFunction;</span><br><span class="line"><span class="keyword">import</span> org.apache.spark.api.java.function.VoidFunction;</span><br><span class="line"><span class="keyword">import</span> org.apache.spark.broadcast.Broadcast;</span><br><span class="line"><span class="keyword">import</span> org.apache.spark.deploy.master.Master;</span><br><span class="line"><span class="keyword">import</span> org.apache.spark.scheduler.DAGScheduler;</span><br><span class="line"><span class="keyword">import</span> scala.Tuple2;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.HashSet;</span><br><span class="line"><span class="keyword">import</span> java.util.Iterator;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestUV</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span>  <span class="keyword">int</span> sum = <span class="number">10</span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SparkConf sparkConf = <span class="keyword">new</span> SparkConf();</span><br><span class="line">        sparkConf.setMaster(<span class="string">"local"</span>).setAppName(<span class="string">"uv"</span>);</span><br><span class="line">        JavaSparkContext context = <span class="keyword">new</span> JavaSparkContext(sparkConf);</span><br><span class="line">        </span><br><span class="line">        JavaRDD&lt;String&gt; lineRDD = context.textFile(<span class="string">"./data/pvuvdata"</span>);</span><br><span class="line">         <span class="comment">/**求每个网站 UV： 用IP唯一标识用户 ，注意去重</span></span><br><span class="line"><span class="comment">         * 文件每一行的内容</span></span><br><span class="line"><span class="comment">115.77.12.186	安徽	2017-10-10	1512012307084	5641635304912151098	www.suning.com</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="comment">//方法一：mapToPair().groupByKey().foreach()</span></span><br><span class="line">        JavaPairRDD&lt;String, Iterable&lt;String&gt;&gt; rdd1 = </span><br><span class="line">            lineRDD.mapToPair(<span class="keyword">new</span> PairFunction&lt;String, String, String&gt;() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> Tuple2&lt;String, String&gt; <span class="title">call</span><span class="params">(String s)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">                String url = s.split(<span class="string">"\t"</span>)[<span class="number">5</span>];</span><br><span class="line">                String ip = s.split(<span class="string">"\t"</span>)[<span class="number">0</span>];</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">new</span> Tuple2&lt;&gt;(url, ip);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;).groupByKey();</span><br><span class="line"></span><br><span class="line">        rdd1.foreach(<span class="keyword">new</span> VoidFunction&lt;Tuple2&lt;String, Iterable&lt;String&gt;&gt;&gt;() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">call</span><span class="params">(Tuple2&lt;String, Iterable&lt;String&gt;&gt; tuple2)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">            <span class="comment">//set:无序，不可重复，所以它可以自动去重</span></span><br><span class="line">                HashSet&lt;Object&gt; set = <span class="keyword">new</span> HashSet&lt;&gt;();</span><br><span class="line">                Iterator&lt;String&gt; iterator = tuple2._2.iterator();</span><br><span class="line">                <span class="keyword">while</span>(iterator.hasNext())&#123;</span><br><span class="line">                    set.add(iterator.next());</span><br><span class="line">                &#125;</span><br><span class="line">                System.out.println(tuple2._1  + <span class="string">" : "</span> + set.size());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//方法二：mapToPair().ditinct().countByKey()--&gt;遍历map</span></span><br><span class="line">        Map&lt;String, Object&gt; map = </span><br><span class="line">            lineRDD.mapToPair(<span class="keyword">new</span> PairFunction&lt;String, String, String&gt;() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> Tuple2&lt;String, String&gt; <span class="title">call</span><span class="params">(String s)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"></span><br><span class="line">                String url = s.split(<span class="string">"\t"</span>)[<span class="number">5</span>];</span><br><span class="line">                String ip = s.split(<span class="string">"\t"</span>)[<span class="number">0</span>];</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">new</span> Tuple2&lt;&gt;(url, ip);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;).distinct().countByKey();</span><br><span class="line">        <span class="keyword">for</span> (String key : map.keySet()) &#123;</span><br><span class="line">            System.out.println(<span class="string">"key : "</span> + key + <span class="string">"   value :"</span> + map.get(key));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-------------------------------------------------------------------------------------</span><br></pre></td></tr></table></figure>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.sxt.scala.core</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.spark.rdd.<span class="type">RDD</span></span><br><span class="line"><span class="keyword">import</span> org.apache.spark.&#123;<span class="type">SparkConf</span>, <span class="type">SparkContext</span>&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">object</span> <span class="title">PVUV</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">main</span></span>(args: <span class="type">Array</span>[<span class="type">String</span>]): <span class="type">Unit</span> = &#123;</span><br><span class="line">        <span class="keyword">val</span> conf = <span class="keyword">new</span> <span class="type">SparkConf</span>()</span><br><span class="line">        conf.setMaster(<span class="string">"local"</span>).setAppName(<span class="string">"pvuv"</span>)</span><br><span class="line">        <span class="keyword">val</span> sc = <span class="keyword">new</span> <span class="type">SparkContext</span>(conf)</span><br><span class="line">        <span class="keyword">val</span> records = sc.textFile(<span class="string">"data/pvuvdata"</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment">//pv</span></span><br><span class="line">        records.map(x =&gt; &#123;</span><br><span class="line">            <span class="keyword">val</span> fields = x.split(<span class="string">"\t"</span>)</span><br><span class="line">            (fields(<span class="number">5</span>), <span class="number">1</span>)</span><br><span class="line">        &#125;).reduceByKey(_ + _).sortBy(_._2).foreach(println)</span><br><span class="line"></span><br><span class="line">        <span class="comment">//uv</span></span><br><span class="line">        <span class="keyword">val</span> result: <span class="type">RDD</span>[(<span class="type">String</span>, <span class="type">Iterable</span>[<span class="type">String</span>])] = records.map(x =&gt; &#123;</span><br><span class="line">            <span class="keyword">val</span> fields = x.split(<span class="string">"\t"</span>)</span><br><span class="line">            (fields(<span class="number">5</span>), fields(<span class="number">0</span>))</span><br><span class="line">        &#125;).groupByKey()</span><br><span class="line"></span><br><span class="line">        result.foreach(x =&gt; &#123;</span><br><span class="line">            <span class="keyword">val</span> key = x._1</span><br><span class="line">            <span class="keyword">val</span> iteratable = x._2</span><br><span class="line"></span><br><span class="line">            println(<span class="string">"key : "</span> + key + <span class="string">" size : "</span> + iteratable.toSet.size)</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.bd.scala.core</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.spark.rdd.<span class="type">RDD</span></span><br><span class="line"><span class="keyword">import</span> org.apache.spark.&#123;<span class="type">SparkConf</span>, <span class="type">SparkContext</span>&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">object</span> <span class="title">PVUV2</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">main</span></span>(args: <span class="type">Array</span>[<span class="type">String</span>]): <span class="type">Unit</span> = &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">val</span> conf = <span class="keyword">new</span> <span class="type">SparkConf</span>()</span><br><span class="line">       <span class="comment">// "local[4]"  指定本地以及使用的核数     </span></span><br><span class="line">        conf.setMaster(<span class="string">"local[4]"</span>).setAppName(<span class="string">"pvuv"</span>)</span><br><span class="line">        <span class="keyword">val</span> context = <span class="keyword">new</span> <span class="type">SparkContext</span>(conf)</span><br><span class="line">        <span class="keyword">val</span> linesRDD = context.textFile(<span class="string">"data/pvuvdata"</span>)</span><br><span class="line">        <span class="comment">//pv</span></span><br><span class="line">        <span class="comment">//(www.jd.com,1000)</span></span><br><span class="line">        linesRDD.map(x=&gt;&#123;</span><br><span class="line">            <span class="keyword">val</span> fields: <span class="type">Array</span>[<span class="type">String</span>] = x.split(<span class="string">"\t"</span>)</span><br><span class="line">            (fields(<span class="number">5</span>),<span class="number">1</span>)</span><br><span class="line">        &#125;).reduceByKey((x,y)=&gt;&#123;x + y&#125;).sortBy(_._2,<span class="literal">false</span>).foreach(println)</span><br><span class="line"></span><br><span class="line">        <span class="comment">//uv</span></span><br><span class="line">        <span class="comment">//(www.taobao.com,10.20.30.18)</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">val</span> groupRDD: <span class="type">RDD</span>[(<span class="type">String</span>, <span class="type">Iterable</span>[<span class="type">String</span>])] = linesRDD.map(x=&gt;&#123;</span><br><span class="line">            <span class="keyword">val</span> fields = x.split(<span class="string">"\t"</span>)</span><br><span class="line">            (fields(<span class="number">5</span>),fields(<span class="number">0</span>))</span><br><span class="line">        &#125;).groupByKey()</span><br><span class="line"></span><br><span class="line">        groupRDD.map(x=&gt;&#123;</span><br><span class="line">            <span class="keyword">val</span> key  = x._1</span><br><span class="line">            <span class="keyword">val</span> size = x._2.toSet.size</span><br><span class="line">            (key,size)</span><br><span class="line">        &#125;).sortBy(_._2,<span class="literal">false</span>)foreach(println)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="案例二：二次排序"><a href="#案例二：二次排序" class="headerlink" title="案例二：二次排序"></a>案例二：二次排序</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.bd.java.core;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.Serializable;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SecondSortKey</span>  <span class="keyword">implements</span> <span class="title">Serializable</span> , <span class="title">Comparable</span>&lt;<span class="title">SecondSortKey</span>&gt;</span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = <span class="number">1L</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> first;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> second;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getFirst</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> first;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setFirst</span><span class="params">(<span class="keyword">int</span> first)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.first = first;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getSecond</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> second;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setSecond</span><span class="params">(<span class="keyword">int</span> second)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.second = second;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">SecondSortKey</span><span class="params">(<span class="keyword">int</span> first, <span class="keyword">int</span> second)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>();</span><br><span class="line">        <span class="keyword">this</span>.first = first;</span><br><span class="line">        <span class="keyword">this</span>.second = second;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">compareTo</span><span class="params">(SecondSortKey o1)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (getFirst() - o1.getFirst() == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">// 5     6</span></span><br><span class="line">            <span class="comment">// this  &lt; o1</span></span><br><span class="line">            <span class="comment">// 6   5</span></span><br><span class="line">            <span class="comment">// this &gt; o1</span></span><br><span class="line">            <span class="keyword">return</span> o1.getSecond() - getSecond();</span><br><span class="line"></span><br><span class="line">            <span class="comment">/*if(getSecond() - o1.getSecond() == 0) &#123;</span></span><br><span class="line"><span class="comment">                return getThree() - o1.getThree();</span></span><br><span class="line"><span class="comment">            &#125;else &#123;</span></span><br><span class="line"><span class="comment">                return getSecond() - o1.getSecond();</span></span><br><span class="line"><span class="comment">            &#125;*/</span></span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span>  o1.getFirst() - getFirst();</span><br><span class="line">    &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.bd.java.core;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.spark.SparkConf;</span><br><span class="line"><span class="keyword">import</span> org.apache.spark.api.java.JavaPairRDD;</span><br><span class="line"><span class="keyword">import</span> org.apache.spark.api.java.JavaRDD;</span><br><span class="line"><span class="keyword">import</span> org.apache.spark.api.java.JavaSparkContext;</span><br><span class="line"><span class="keyword">import</span> org.apache.spark.api.java.function.PairFunction;</span><br><span class="line"><span class="keyword">import</span> org.apache.spark.api.java.function.VoidFunction;</span><br><span class="line"><span class="keyword">import</span> scala.Tuple2;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SecondKeyTest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SparkConf sparkConf = <span class="keyword">new</span> SparkConf();</span><br><span class="line">        sparkConf.setMaster(<span class="string">"local"</span>).setAppName(<span class="string">"SecondarySortTest"</span>);</span><br><span class="line">        <span class="keyword">final</span> JavaSparkContext sc = <span class="keyword">new</span> JavaSparkContext(sparkConf);</span><br><span class="line"></span><br><span class="line">        JavaRDD&lt;String&gt; secondRDD = sc.textFile(<span class="string">"./data/secondSort.txt"</span>);</span><br><span class="line">        <span class="comment">/*文件内容格式</span></span><br><span class="line"><span class="comment">         * 1 3</span></span><br><span class="line"><span class="comment">         * 1 4</span></span><br><span class="line"><span class="comment">         * 2 3</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="comment">//maptoPair --&gt;sortByKey --&gt;foreach</span></span><br><span class="line">        JavaPairRDD&lt;SecondSortKey, String&gt; secRDD = </span><br><span class="line">            secondRDD.mapToPair(<span class="keyword">new</span> PairFunction&lt;String, SecondSortKey, String&gt;() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">           <span class="function"><span class="keyword">public</span> Tuple2&lt;SecondSortKey, String&gt; <span class="title">call</span><span class="params">(String line)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">                String[] fields = line.split(<span class="string">" "</span>);</span><br><span class="line">                SecondSortKey secondSortKey =<span class="keyword">new</span> SecondSortKey(</span><br><span class="line">                    Integer.parseInt(fields[<span class="number">0</span>]),</span><br><span class="line">                    Integer.parseInt(fields[<span class="number">1</span>])</span><br><span class="line">                );  		  		 </span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">new</span> Tuple2&lt;&gt;(secondSortKey, line);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">      secRDD.sortByKey().foreach(<span class="keyword">new</span> VoidFunction&lt;Tuple2&lt;SecondSortKey, String&gt;&gt;() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">           <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">call</span><span class="params">(Tuple2&lt;SecondSortKey, String&gt; tuple2)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">                System.out.println(tuple2._2);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-------------------------------------------------------------------------------------</span><br></pre></td></tr></table></figure>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h1 id="案例三：分组取topN"><a href="#案例三：分组取topN" class="headerlink" title="案例三：分组取topN"></a>案例三：分组取topN</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.sxt.java.core;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.spark.SparkConf;</span><br><span class="line"><span class="keyword">import</span> org.apache.spark.api.java.JavaPairRDD;</span><br><span class="line"><span class="keyword">import</span> org.apache.spark.api.java.JavaRDD;</span><br><span class="line"><span class="keyword">import</span> org.apache.spark.api.java.JavaSparkContext;</span><br><span class="line"><span class="keyword">import</span> org.apache.spark.api.java.function.PairFunction;</span><br><span class="line"><span class="keyword">import</span> org.apache.spark.api.java.function.VoidFunction;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> scala.Tuple2;</span><br><span class="line"><span class="keyword">import</span> java.util.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TopN</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SparkConf conf;</span><br><span class="line">        conf = <span class="keyword">new</span> SparkConf().setMaster(<span class="string">"local[5]"</span>).setAppName(<span class="string">"TopOps"</span>);</span><br><span class="line">        JavaSparkContext sc = <span class="keyword">new</span> JavaSparkContext(conf);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//hdfs://shsxt/wc.txt</span></span><br><span class="line">        JavaRDD&lt;String&gt; linesRDD = sc.textFile(<span class="string">"data/scores.txt"</span>,<span class="number">5</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> List n = <span class="keyword">new</span> ArrayList();</span><br><span class="line"><span class="comment">//      linesRDD.count();</span></span><br><span class="line"><span class="comment">/*a 86</span></span><br><span class="line"><span class="comment"> a 58</span></span><br><span class="line"><span class="comment">  b 78</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line">        JavaPairRDD&lt;String, Integer&gt; pairRDD = </span><br><span class="line">        linesRDD.mapToPair( <span class="keyword">new</span> PairFunction&lt;String, String, Integer&gt;() &#123;</span><br><span class="line">                    <span class="comment">/**</span></span><br><span class="line"><span class="comment">                     *</span></span><br><span class="line"><span class="comment">                     */</span></span><br><span class="line">                 <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = <span class="number">1L</span>;</span><br><span class="line">                 <span class="meta">@Override</span></span><br><span class="line">                 <span class="function"><span class="keyword">public</span> Tuple2&lt;String, Integer&gt; <span class="title">call</span><span class="params">(String str)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">                        String[] splited = str.split(<span class="string">" "</span>);</span><br><span class="line">                        String clazzName = splited[<span class="number">0</span>];</span><br><span class="line">                        Integer score = Integer.valueOf(splited[<span class="number">1</span>]);</span><br><span class="line">                        <span class="keyword">return</span> <span class="keyword">new</span> Tuple2&lt;String, Integer&gt;(clazzName, score);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;);</span><br><span class="line"></span><br><span class="line">     JavaPairRDD&lt;String, Iterable&lt;Integer&gt;&gt; groupByKeyRDD =pairRDD.groupByKey();</span><br><span class="line">     groupByKeyRDD.foreach( <span class="keyword">new</span> VoidFunction&lt;Tuple2&lt;String, Iterable&lt;Integer&gt;&gt;&gt;() &#123;</span><br><span class="line">                    <span class="comment">/**</span></span><br><span class="line"><span class="comment">                     *</span></span><br><span class="line"><span class="comment">                     */</span></span><br><span class="line">                    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = <span class="number">1L</span>;</span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">       <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">call</span><span class="params">(Tuple2&lt;String, Iterable&lt;Integer&gt;&gt; tuple)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">                        String clazzName = tuple._1;</span><br><span class="line">                        Iterator&lt;Integer&gt; iterator = tuple._2.iterator();</span><br><span class="line">                        System.out.println(tuple);</span><br><span class="line">                        <span class="comment">//取前三：大的放前，小的后移</span></span><br><span class="line">                        Integer[] top3 = <span class="keyword">new</span> Integer[<span class="number">3</span>];</span><br><span class="line">                        <span class="keyword">while</span> (iterator.hasNext()) &#123;</span><br><span class="line">                            Integer score = iterator.next();</span><br><span class="line">                            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; top3.length; i++) &#123;</span><br><span class="line">                                <span class="keyword">if</span> (top3[i] == <span class="keyword">null</span>) &#123;</span><br><span class="line">                                    top3[i] = score;</span><br><span class="line">                                    <span class="keyword">break</span>;</span><br><span class="line">                                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (score &gt; top3[i]) &#123;</span><br><span class="line">                                    <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">2</span>; j &gt; i; j--) &#123;</span><br><span class="line">                                        top3[j] = top3[j - <span class="number">1</span>];</span><br><span class="line">                                    &#125;</span><br><span class="line">                                    top3[i] = score;</span><br><span class="line">                                    <span class="keyword">break</span>;</span><br><span class="line">                                &#125;</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                        System.out.println(<span class="string">"class Name:"</span> + clazzName);</span><br><span class="line">                        <span class="keyword">for</span> (Integer sscore : top3) &#123;</span><br><span class="line">                            System.out.println(sscore);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">//     groupByKeyRDD.foreach(new VoidFunction&lt;Tuple2&lt;String, Iterable&lt;Integer&gt;&gt;&gt;() &#123;</span></span><br><span class="line"><span class="comment">//            @Override</span></span><br><span class="line"><span class="comment">//     public void call(Tuple2&lt;String, Iterable&lt;Integer&gt;&gt; tuple2) throws Exception &#123;</span></span><br><span class="line"><span class="comment">//                String key  = tuple2._1;</span></span><br><span class="line"><span class="comment">//                Iterator&lt;Integer&gt; iterator = tuple2._2.iterator();</span></span><br><span class="line"><span class="comment">//                List list = IteratorUtils.toList(iterator);</span></span><br><span class="line"><span class="comment">//                Collections.sort(list);</span></span><br><span class="line"><span class="comment">//                for(int i=0;i&lt;Math.min(3,list.size());i++)&#123;</span></span><br><span class="line"><span class="comment">//                    // list.size = 3  list.get(2)</span></span><br><span class="line"><span class="comment">//                    System.out.println(key + " " +  list.get(list.size()-i-1));</span></span><br><span class="line"><span class="comment">//                &#125;</span></span><br><span class="line"><span class="comment">//            &#125;</span></span><br><span class="line"><span class="comment">//        &#125;);</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-----------------------------------------------------------------------------------</span><br></pre></td></tr></table></figure>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.sxt.scala.core</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Licensed to the Apache Software Foundation (ASF) under one or more</span></span><br><span class="line"><span class="comment"> * contributor license agreements.  See the NOTICE file distributed with</span></span><br><span class="line"><span class="comment"> * this work for additional information regarding copyright ownership.</span></span><br><span class="line"><span class="comment"> * The ASF licenses this file to You under the Apache License, Version 2.0</span></span><br><span class="line"><span class="comment"> * (the "License"); you may not use this file except in compliance with</span></span><br><span class="line"><span class="comment"> * the License.  You may obtain a copy of the License at</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *    http://www.apache.org/licenses/LICENSE-2.0</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Unless required by applicable law or agreed to in writing, software</span></span><br><span class="line"><span class="comment"> * distributed under the License is distributed on an "AS IS" BASIS,</span></span><br><span class="line"><span class="comment"> * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span></span><br><span class="line"><span class="comment"> * See the License for the specific language governing permissions and</span></span><br><span class="line"><span class="comment"> * limitations under the License.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.spark.&#123;<span class="type">SparkConf</span>, <span class="type">SparkContext</span>&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Computes the PageRank of URLs from an input file. Input file should</span></span><br><span class="line"><span class="comment"> * be in format of:</span></span><br><span class="line"><span class="comment"> * URL         neighbor URL</span></span><br><span class="line"><span class="comment"> * URL         neighbor URL</span></span><br><span class="line"><span class="comment"> * URL         neighbor URL</span></span><br><span class="line"><span class="comment"> * ...</span></span><br><span class="line"><span class="comment"> * where URL and their neighbors are separated by space(s).</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">object</span> <span class="title">SparkPageRank</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">main</span></span>(args: <span class="type">Array</span>[<span class="type">String</span>]) &#123;</span><br><span class="line">    <span class="comment">//    if (args.length &lt; 1) &#123;</span></span><br><span class="line">    <span class="comment">//      System.err.println("Usage: SparkPageRank &lt;file&gt; &lt;iter&gt;")</span></span><br><span class="line">    <span class="comment">//      System.exit(1)</span></span><br><span class="line">    <span class="comment">//    &#125;</span></span><br><span class="line">    <span class="keyword">val</span> sparkConf = <span class="keyword">new</span> <span class="type">SparkConf</span>().setAppName(<span class="string">"PageRank"</span>).setMaster(<span class="string">"local[1]"</span>)</span><br><span class="line">    <span class="keyword">val</span> iters = <span class="number">20</span>;</span><br><span class="line">    <span class="comment">//    val iters = if (args.length &gt; 0) args(1).toInt else 10</span></span><br><span class="line">    <span class="keyword">val</span> ctx = <span class="keyword">new</span> <span class="type">SparkContext</span>(sparkConf)</span><br><span class="line">    <span class="keyword">val</span> lines = ctx.textFile(<span class="string">"page.txt"</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">//根据边关系数据生成 邻接表 如：(1,(2,3,4,5)) (2,(1,5))..</span></span><br><span class="line">    <span class="keyword">val</span> links = lines.map&#123; s =&gt;</span><br><span class="line">      <span class="keyword">val</span> parts = s.split(<span class="string">"\\s+"</span>)</span><br><span class="line">      (parts(<span class="number">0</span>), parts(<span class="number">1</span>))</span><br><span class="line">    &#125;.distinct().groupByKey().cache()</span><br><span class="line"></span><br><span class="line">    links.foreach(println)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// (1,1.0) (2,1.0)..</span></span><br><span class="line">    <span class="keyword">var</span> ranks = links.mapValues(v =&gt; <span class="number">1.0</span>)</span><br><span class="line"></span><br><span class="line">    ranks.foreach(println)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (i &lt;- <span class="number">1</span> to iters) &#123;</span><br><span class="line">      <span class="comment">// (1,((2,3,4,5), 1.0))</span></span><br><span class="line">      <span class="keyword">val</span> contribs = links.join(ranks).values.flatMap&#123; <span class="keyword">case</span> (urls, rank) =&gt;</span><br><span class="line">        <span class="keyword">val</span> size = urls.size</span><br><span class="line">        urls.map(url =&gt; (url, rank / size))</span><br><span class="line">      &#125;</span><br><span class="line">      ranks = contribs.reduceByKey(_ + _).mapValues(<span class="number">0.15</span> + <span class="number">0.85</span> * _)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">val</span> output = ranks.collect()</span><br><span class="line"><span class="comment">//    output.foreach(tup =&gt; println(tup._1 + " has rank: " + tup._2 + "."))</span></span><br><span class="line"></span><br><span class="line">    ctx.stop()</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="参数解释：spark-submit"><a href="#参数解释：spark-submit" class="headerlink" title="参数解释：spark-submit"></a>参数解释：spark-submit</h1><p>spark-submit -h</p>
<p>–master  （优先使用代码中的配置）</p>
<p>–name    （指定APPname）</p>
<p>–deploy mode  （默认为client，指定运行模式）</p>
<p>–jars （可以用来为代码添加所需要的jar包依赖）</p>
<p>IDEA代码打包：BUILD（注意避免jar包过大，可）</p>
<p>–files （添加代码所需的文件）</p>
<p>–conf （PROP=value）</p>
<p>–driver-memory</p>
<p>–executor-memory</p>
<p>–total-executor-core    （若不指明，就把所有的核均用完）</p>
<p>–queue</p>
<p>资源分配：</p>
<p>yarn  ： 分配到队列中 </p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line">[root@node00 bin]# ./spark-submit -h</span><br><span class="line">Usage: spark-submit [options] &lt;app jar | python file&gt; [app arguments]</span><br><span class="line">Usage: spark-submit --kill [submission ID] --master [spark://...]</span><br><span class="line">Usage: spark-submit --status [submission ID] --master [spark://...]</span><br><span class="line"></span><br><span class="line">Options:</span><br><span class="line">  --master MASTER_URL         spark://host:port, mesos://host:port, yarn, or local.</span><br><span class="line">  --deploy-mode DEPLOY_MODE   Whether to launch the driver program locally("client")                               or on one of the worker machines inside the  cluster                                 ("cluster") (Default: client).</span><br><span class="line">  --class CLASS_NAME          Your application's main class (for Java / Scala apps).</span><br><span class="line">  --name NAME                 A name of your application.</span><br><span class="line">  --jars JARS                 Comma-separated (逗号分隔) list of local jars to include                               on the driver and executor classpaths.(Driver 和                                     executor 依赖的第三方 jar 包)</span><br><span class="line">  --packages                  Comma-separated list of maven coordinates of jars to                                 include on the driver and executor classpaths. Will                                 search the local maven repo, then maven central and                                 any additional remote repositories given by --                                       repositories. The format for the coordinates should be                               groupId:artifactId:version.</span><br><span class="line">  --exclude-packages          Comma-separated list of groupId:artifactId, to exclude                               while resolving the dependencies provided in --                                     packages to avoid dependency conflicts.</span><br><span class="line">  --repositories              Comma-separated list of additional remote repositories                               to search for the maven coordinates given with --                                   packages.</span><br><span class="line">  --py-files PY_FILES         Comma-separated list of .zip, .egg, or .py files to                                 place on the PYTHONPATH for Python apps.</span><br><span class="line">  --files FILES               Comma-separated list of files to be placed in the                                   working directory of each executor.</span><br><span class="line"></span><br><span class="line">  --conf PROP=VALUE           Arbitrary Spark configuration property.</span><br><span class="line">  --properties-file FILE      Path to a file from which to load extra properties. If                               not specified, this will look for conf/spark-                                       defaults.conf.</span><br><span class="line"></span><br><span class="line">  --driver-memory MEM         Memory for driver (e.g. 1000M, 2G) (Default: 1024M).</span><br><span class="line">  --driver-java-options       Extra Java options to pass to the driver.</span><br><span class="line">  --driver-library-path       Extra library path entries to pass to the driver.</span><br><span class="line">  --driver-class-path         Extra class path entries to pass to the driver. Note                                 that jars added with --jars are automatically included                               in the  classpath.</span><br><span class="line"></span><br><span class="line">  --executor-memory MEM       Memory per executor (e.g. 1000M, 2G) (Default: 1G).</span><br><span class="line"></span><br><span class="line">  --proxy-user NAME           User to impersonate when submitting the application.</span><br><span class="line"></span><br><span class="line">  --help, -h                  Show this help message and exit</span><br><span class="line">  --verbose, -v               Print additional debug output</span><br><span class="line">  --version,                  Print the version of current Spark</span><br><span class="line"></span><br><span class="line"> Spark standalone with cluster deploy mode only:</span><br><span class="line">  --driver-cores NUM          Cores for driver (Default: 1).</span><br><span class="line"></span><br><span class="line"> Spark standalone or Mesos with cluster deploy mode only:</span><br><span class="line">  --supervise                 If given, restarts the driver on failure.</span><br><span class="line">  --kill SUBMISSION_ID        If given, kills the driver specified.</span><br><span class="line">  --status SUBMISSION_ID      If given, requests the status of the driver specified.</span><br><span class="line"></span><br><span class="line"> Spark standalone and Mesos only:</span><br><span class="line">  --total-executor-cores NUM  Total cores for all executors.</span><br><span class="line"></span><br><span class="line"> Spark standalone and YARN only:</span><br><span class="line">  --executor-cores NUM        Number of cores per executor. (Default: 1 in YARN                                   mode, or all available cores on the worker in                                       standalone mode)</span><br><span class="line"></span><br><span class="line"> YARN-only:</span><br><span class="line">  --driver-cores NUM          Number of cores used by the driver, only in cluster                                 mode (Default: 1).</span><br><span class="line">  --queue QUEUE_NAME          The YARN queue to submit to (Default: "default").</span><br><span class="line">  --num-executors NUM         Number of executors to launch (Default: 2).</span><br><span class="line">  --archives ARCHIVES         Comma separated list of archives to be extracted into                               the working directory of each executor.</span><br><span class="line">  --principal PRINCIPAL       Principal to be used to login to KDC, while running on</span><br><span class="line">                              secure HDFS.</span><br><span class="line">  --keytab KEYTAB             The full path to the file that contains the keytab for                               the principal specified above. This keytab will be                                   copied to the node running the Application Master via                               the Secure Distributed Cache, for renewing the login                                 tickets and the delegation tokens periodically.</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">sc.textFile("hdfs://node00:8020/test.txt").flatMap(_.split(" ")).map((_,1)).reduceByKey(_+_).foreach(println)</span><br></pre></td></tr></table></figure>
<h1 id="Spark-Shell"><a href="#Spark-Shell" class="headerlink" title="Spark Shell"></a>Spark Shell</h1><h2 id="1、-概念："><a href="#1、-概念：" class="headerlink" title="1、 概念："></a>1、 概念：</h2><p>SparkShell 是 Spark 自带的一个快速原型开发工具，也可以说是Spark 的 scala REPL(Read-Eval-Print-Loop),即交互式 shell。支持使用 scala 语言来进行 Spark 的交互式编程。</p>
<h2 id="2、使用"><a href="#2、使用" class="headerlink" title="2、使用:"></a>2、使用:</h2><p>（配置从HDFS上获取文件）</p>
<p>(1)启动HDFS，上传文件</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">zkServer.sh start   (3台)</span><br><span class="line">start-all.sh        (任一台)</span><br><span class="line">hadoop dfs -put test.txt /   (任一台：将test.txt文件上传至hdfs的根目录)</span><br></pre></td></tr></table></figure>
<p>(2)启动standalone集群：在/sbin路径下</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./start-all.sh</span><br></pre></td></tr></table></figure>
<p>(3)在客户端上启动 spark-shell:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./spark-shell    (local模式：在控制台打印)</span><br></pre></td></tr></table></figure>
<p>或</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./spark-shell --master spark://node00:7077   （client模式：控制台无打印，可通过web页面查看）</span><br></pre></td></tr></table></figure>
<p>（4）运行 wordcount：</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sc.textFile(<span class="string">"hdfs://Sunrise/test.txt"</span>).flatMap(_.split(<span class="string">" "</span>)).map((_,<span class="number">1</span>)).reduceByKey(_+_).foreach(println)</span><br></pre></td></tr></table></figure>
<h2 id="三、参数解释：spark-shell"><a href="#三、参数解释：spark-shell" class="headerlink" title="三、参数解释：spark-shell"></a>三、参数解释：spark-shell</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line">[root@node00 bin]# ./spark-shell -h</span><br><span class="line">Usage: ./bin/spark-shell [options]</span><br><span class="line"></span><br><span class="line">Options:</span><br><span class="line">  --master MASTER_URL         spark://host:port, mesos://host:port, yarn, or local.</span><br><span class="line">  --deploy-mode DEPLOY_MODE   Whether to launch the driver program locally                                         ("client") or on one of the worker machines inside the                               cluster ("cluster")(Default: client).</span><br><span class="line">  --class CLASS_NAME          Your application's main class (for Java / Scala apps).</span><br><span class="line">  --name NAME                 A name of your application.</span><br><span class="line">  --jars JARS                 Comma-separated list of local jars to include on the                                 driver and executor classpaths.</span><br><span class="line">  --packages                  Comma-separated list of maven coordinates of jars to                                 include on the driver and executor classpaths. Will                                 search the local maven repo, then maven central and                                 any additional remote repositories given by --                                       repositories. The format for thecoordinates should be                               groupId:artifactId:version.</span><br><span class="line">  --exclude-packages          Comma-separated list of groupId:artifactId, to exclude                               while  resolving the dependencies provided in --                                     packages to avoid dependency conflicts.</span><br><span class="line">  --repositories              Comma-separated list of additional remote repositories                               to search for the maven coordinates given with --                                   packages.</span><br><span class="line">  --py-files PY_FILES         Comma-separated list of .zip, .egg, or .py files to                                 place on the PYTHONPATH for Python apps.</span><br><span class="line">  --files FILES               Comma-separated list of files to be placed in the                                   working directory of each executor.</span><br><span class="line"></span><br><span class="line">  --conf PROP=VALUE           Arbitrary Spark configuration property.</span><br><span class="line">  --properties-file FILE      Path to a file from which to load extra properties. If                               not specified, this will look for conf/spark-                                       defaults.conf.</span><br><span class="line"></span><br><span class="line">  --driver-memory MEM         Memory for driver (e.g. 1000M, 2G) (Default: 1024M).</span><br><span class="line">  --driver-java-options       Extra Java options to pass to the driver.</span><br><span class="line">  --driver-library-path       Extra library path entries to pass to the driver.</span><br><span class="line">  --driver-class-path         Extra class path entries to pass to the driver. Note                                 that jars added with --jars are automatically included                               in the classpath.</span><br><span class="line"></span><br><span class="line">  --executor-memory MEM       Memory per executor (e.g. 1000M, 2G) (Default: 1G).</span><br><span class="line"></span><br><span class="line">  --proxy-user NAME           User to impersonate when submitting the application.</span><br><span class="line"></span><br><span class="line">  --help, -h                  Show this help message and exit</span><br><span class="line">  --verbose, -v               Print additional debug output</span><br><span class="line">  --version,                  Print the version of current Spark</span><br><span class="line"></span><br><span class="line"> Spark standalone with cluster deploy mode only:</span><br><span class="line">  --driver-cores NUM          Cores for driver (Default: 1).</span><br><span class="line"></span><br><span class="line"> Spark standalone or Mesos with cluster deploy mode only:</span><br><span class="line">  --supervise                 If given, restarts the driver on failure.</span><br><span class="line">  --kill SUBMISSION_ID        If given, kills the driver specified.</span><br><span class="line">  --status SUBMISSION_ID      If given, requests the status of the driver specified.</span><br><span class="line"></span><br><span class="line"> Spark standalone and Mesos only:</span><br><span class="line">  --total-executor-cores NUM  Total cores for all executors.</span><br><span class="line"></span><br><span class="line"> Spark standalone and YARN only:</span><br><span class="line">  --executor-cores NUM        Number of cores per executor. (Default: 1 in YARN                                   mode, or all available cores on the worker in                                       standalone mode)</span><br><span class="line"></span><br><span class="line"> YARN-only:</span><br><span class="line">  --driver-cores NUM          Number of cores used by the driver, only in cluster                                 mode (Default: 1).</span><br><span class="line">  --queue QUEUE_NAME          The YARN queue to submit to (Default: "default").</span><br><span class="line">  --num-executors NUM         Number of executors to launch (Default: 2).</span><br><span class="line">  --archives ARCHIVES         Comma separated list of archives to be extracted into                               the working directory of each executor.</span><br><span class="line">  --principal PRINCIPAL       Principal to be used to login to KDC, while running on</span><br><span class="line">                              secure HDFS.</span><br><span class="line">  --keytab KEYTAB             The full path to the file that contains the keytab for                               the principal specified above. This keytab will be                                   copied to the node running the Application Master via                               the Secure Distributed Cache, for renewing the login                                 tickets and the delegation tokens periodically.</span><br></pre></td></tr></table></figure>
<h1 id="SparkUI"><a href="#SparkUI" class="headerlink" title="SparkUI"></a>SparkUI</h1><h2 id="1、SparkUI-界面介绍"><a href="#1、SparkUI-界面介绍" class="headerlink" title="1、SparkUI 界面介绍"></a>1、SparkUI 界面介绍</h2><p>提交spark：在/bin路径下</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./spark-submit --master spark://node00:7077 --name sp --class org.apache.spark.example.SparkPi ../lib/spark-examples-1.6.0-hadoop2.6.0.jar --100</span><br></pre></td></tr></table></figure>
<p><code>注意</code>：–name指代的参数在代码中也有配置，所以对同一参数均有配置时，以代码中的配置为主</p>
<p>浏览器页面访问：node00:8080  </p>
<p><code>页面显示</code></p>
<blockquote>
<p>点击：Application ID列中的值  →  Application  Detail UI  会显示查看不了事件日志</p>
<h3 id="Event-logging-is-not-enabled"><a href="#Event-logging-is-not-enabled" class="headerlink" title="Event logging is not enabled"></a>Event logging is not enabled</h3><p>No event logs were found for this application! To <a href="http://spark.apache.org/docs/latest/monitoring.html" target="_blank" rel="noopener">enable event logging</a>, set spark.eventLog.enabled to true and spark.eventLog.dir to the directory to which your event logs are written.</p>
</blockquote>
<h2 id="2、配置-historyServer"><a href="#2、配置-historyServer" class="headerlink" title="2、配置 historyServer"></a>2、配置 historyServer</h2><ul>
<li>临时配置，对本次提交的应用程序起作用</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">./spark-shell --master spark://node00:7077</span><br><span class="line">--name myapp1</span><br><span class="line">--conf spark.eventLog.enabled=true</span><br><span class="line">--conf spark.eventLog.dir=hdfs://Sunrise/spark/test</span><br></pre></td></tr></table></figure>
<p>停止程序，在 Web Ui 中 Completed Applications 对应的ApplicationID 中能查看 history。</p>
<ul>
<li>spark-default.conf 配置文件中配置 HistoryServer，对所有提交的Application 都起作用</li>
</ul>
<p>在 客 户 端 节 点 ， 进 入 ../spark-1.6.0/conf/spark-defaults.conf 最后加入:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">#  开启记录事件日志的功能</span><br><span class="line">spark.eventLog.enabled true</span><br><span class="line">#  设置事件日志存储的目录</span><br><span class="line">spark.eventLog.dir hdfs://Sunrise/spark/test</span><br><span class="line">#  设置 HistoryServer  加载事件日志的位置</span><br><span class="line">spark.history.fs.logDirectory hdfs://Sunrise/spark/test</span><br><span class="line"># 日志优化选项, 压缩日志</span><br><span class="line">spark.eventLog.compress true</span><br></pre></td></tr></table></figure>
<ul>
<li>发送到其他节点（如果节点上没有以上配置，就不会有对应的作用）</li>
</ul>
<p>在HDFS上一定要先存在路径/spark/test</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#hdfs集群一定要启动</span><br><span class="line">hadoop dfs -mkdir -p /spark/test</span><br></pre></td></tr></table></figure>
<p><code>页面显示</code></p>
<blockquote>
<p>点击：Application ID列中的值  →  Application  Detail UI  就会有显示内容</p>
</blockquote>
<p><img src="https://ws1.sinaimg.cn/large/005zftzDgy1g0d8nkvqzrj310k06zmxl.jpg" alt=""></p>
<p><img src="https://ws1.sinaimg.cn/large/005zftzDgy1g0d8r7qsrzj30q50apwgd.jpg" alt=""></p>
<ul>
<li>启动 HistoryServer：(在/sbin路径下)</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./start-history-server.sh</span><br></pre></td></tr></table></figure>
<p>（Sunrise在这里是HDFS集群的名字）</p>
<p>访问 HistoryServer：</p>
<p>node00:18080,之后所有提交的应用程序运行状况都会被记录。</p>
<p><img src="https://ws1.sinaimg.cn/large/005zftzDgy1g0d8t4eeftj30xj079go4.jpg" alt=""></p>
<h1 id="Master-HA"><a href="#Master-HA" class="headerlink" title="Master HA"></a>Master HA</h1><h2 id="1、Master-的高可用原理"><a href="#1、Master-的高可用原理" class="headerlink" title="1、Master 的高可用原理"></a>1、Master 的高可用原理</h2><p>Standalone 集群只有一个 Master，如果 Master 挂了就无法提交应用程序，但不影响正在执行的worker。</p>
<p>给 Master 进行高可用配置可以使用<strong>fileSystem</strong>(文件系统)和 <strong>zookeeper</strong>（分布式协调服务）。</p>
<ul>
<li><p>fileSystem 只有存储功能，可以存储 Master 的元数据信息，用fileSystem 搭建的 Master 高可用，在 Master 失败时，需要我们手动启动另外的备用 Master，这种方式不推荐使用。</p>
</li>
<li><p>zookeeper 有选举和存储功能，可以存储 Master 的元素据信息，使用zookeeper 搭建的 Master 高可用，当 Master 挂掉时，备用的 Master会自动切换，推荐使用这种方式搭建 Master 的 HA。</p>
</li>
</ul>
<p><img src="https://ws1.sinaimg.cn/large/005zftzDgy1g0d8unf1yfj30gn0beac3.jpg" alt=""></p>
<h2 id="2、Master-高可用搭建"><a href="#2、Master-高可用搭建" class="headerlink" title="2、Master 高可用搭建"></a>2、Master 高可用搭建</h2><p>1) 在 Spark Master 节点上配置主 Master，配置.spark1.6.0/conf/ spark-env.sh</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">export</span> SPARK_DAEMON_JAVA_OPTS=<span class="string">"</span></span><br><span class="line"><span class="string">-Dspark.deploy.recoveryMode=ZOOKEEPER</span></span><br><span class="line"><span class="string">-Dspark.deploy.zookeeper.url=node00:2181,node01:2181,node02:2181</span></span><br><span class="line"><span class="string">-Dspark.deploy.zookeeper.dir=/sparkmaster"</span></span><br></pre></td></tr></table></figure>
<p>2) 发送到其他 worker 节点上</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">scp spark-env.sh node01:`pwd`</span><br><span class="line">.......</span><br></pre></td></tr></table></figure>
<p>3) 找一台节点（非主 Master 节点:node01）配置备用 Master,修改spark-env.sh 配置节点上的 MasterIP</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SPARK_MASTER_IP=192.168.198.130</span><br></pre></td></tr></table></figure>
<p>4) 启动集群之前启动 zookeeper 集群：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">zkServer.sh start</span><br></pre></td></tr></table></figure>
<p>5) 启动 spark Standalone 集群，启动备用 Master</p>
<p>node00:(在/sbin路径下)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./start-all.sh</span><br></pre></td></tr></table></figure>
<p>node01:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./start-master.sh</span><br></pre></td></tr></table></figure>
<p>6) 打开主 Master 和备用 Master WebUI 页面，观察状态</p>
<p>主master：</p>
<blockquote>
<h3 id="1-6-0-Spark-Master-at-spark-192-168-198-128-7077"><a href="#1-6-0-Spark-Master-at-spark-192-168-198-128-7077" class="headerlink" title=" 1.6.0 Spark Master at spark://192.168.198.128:7077"></a><a href="http://node00:8080/" target="_blank" rel="noopener"><img src="http://node00:8080/static/spark-logo-77x50px-hd.png" alt="img"><span class="img-alt">img</span> 1.6.0 </a>Spark Master at spark://192.168.198.128:7077</h3><ul>
<li><strong>URL:</strong> spark://192.168.198.128:7077</li>
<li><strong>REST URL:</strong> spark://192.168.198.128:6066 (cluster mode)</li>
<li><strong>Alive Workers:</strong> 2</li>
<li><strong>Cores in use:</strong> 2 Total, 0 Used</li>
<li><strong>Memory in use:</strong> 2.0 GB Total, 0.0 B Used</li>
<li><strong>Applications:</strong> 0 Running, 6 Completed</li>
<li><strong>Drivers:</strong> 0 Running, 0 Completed</li>
<li><strong>Status:</strong> ALIVE</li>
</ul>
</blockquote>
<p>备用master：</p>
<blockquote>
<h3 id="1-6-0-Spark-Master-at-spark-192-168-198-130-7077"><a href="#1-6-0-Spark-Master-at-spark-192-168-198-130-7077" class="headerlink" title=" 1.6.0 Spark Master at spark://192.168.198.130:7077"></a><a href="http://node01:8080/" target="_blank" rel="noopener"><img src="http://node01:8080/static/spark-logo-77x50px-hd.png" alt="img"><span class="img-alt">img</span> 1.6.0 </a>Spark Master at spark://192.168.198.130:7077</h3><ul>
<li><strong>URL:</strong> spark://192.168.198.130:7077</li>
<li><strong>REST URL:</strong> spark://192.168.198.130:6066 (cluster mode)</li>
<li><strong>Alive Workers:</strong> 0</li>
<li><strong>Cores in use:</strong> 0 Total, 0 Used</li>
<li><strong>Memory in use:</strong> 0.0 B Total, 0.0 B Used</li>
<li><strong>Applications:</strong> 0 Running, 0 Completed</li>
<li><strong>Drivers:</strong> 0 Running, 0 Completed</li>
<li><strong>Status:</strong> ALIVE</li>
</ul>
</blockquote>
<ol start="3">
<li><p>注意点<br>  主备切换过程中不能提交 Application。<br>  主备切换过程中不影响已经在集群中运行的 Application。因为<br> Spark 是粗粒度资源调度。</p>
</li>
<li><p>测试验证<br> 提交 SparkPi 程序，kill 主 Master 观察现象。</p>
</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./spark-submit --master spark://node00:7077,node01:7077 --class org.apache.spark.examples.SparkPi ../lib/spark-examples-1.6.0-hadoop2.6.0.jar 10000</span><br></pre></td></tr></table></figure>
<p><code>显示：</code></p>
<blockquote>
<p>主备切换有时差，因为也不急</p>
<p>程序不受影响</p>
</blockquote>

      
    </div>
    
  </div>
  
    
    <div class="copyright">
        <p><span>本文标题:</span><a href="/2019/02/18/Spark学习（三）/">Spark学习（三）</a></p>
        <p><span>文章作者:</span><a href="/" title="回到主页">Sukie</a></p>
        <p><span>发布时间:</span>2019-02-18, 00:00:00</p>
        <p><span>最后更新:</span>2019-02-22, 09:56:24</p>
        <p>
            <span>原始链接:</span><a class="post-url" href="/2019/02/18/Spark学习（三）/" title="Spark学习（三）">http://sungithup.github.io/2019/02/18/Spark学习（三）/</a>
            <span class="copy-path" data-clipboard-text="原文: http://sungithup.github.io/2019/02/18/Spark学习（三）/　　作者: Sukie" title="点击复制文章链接"><i class="fa fa-clipboard"></i></span>
            <script> var clipboard = new Clipboard('.copy-path'); </script>
        </p>
        <p>
            <span>许可协议:</span><i class="fa fa-creative-commons"></i> <a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/" title="CC BY-NC-SA 4.0 International" target="_blank">"署名-非商用-相同方式共享 4.0"</a> 转载请保留原文链接及作者。
        </p>
    </div>



    <nav id="article-nav">
        
            <div id="article-nav-newer" class="article-nav-title">
                <a href="/2019/02/19/Spark学习（四）/">
                    Spark学习（四）
                </a>
            </div>
        
        
            <div id="article-nav-older" class="article-nav-title">
                <a href="/2019/02/17/Spark学习（二）/">
                    Spark学习(二)
                </a>
            </div>
        
    </nav>

  
</article>

    <div id="toc" class="toc-article">
        <strong class="toc-title">文章目录</strong>
        
            <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#案例一、统计网站-pv-和-uv统计"><span class="toc-text">案例一、统计网站 pv 和 uv统计</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#0、概念理解"><span class="toc-text">0、概念理解</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1、什么是-PV-值"><span class="toc-text">1、什么是 PV 值</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2、什么是UV-值"><span class="toc-text">2、什么是UV 值</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#案例二：二次排序"><span class="toc-text">案例二：二次排序</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#案例三：分组取topN"><span class="toc-text">案例三：分组取topN</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#参数解释：spark-submit"><span class="toc-text">参数解释：spark-submit</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Spark-Shell"><span class="toc-text">Spark Shell</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1、-概念："><span class="toc-text">1、 概念：</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2、使用"><span class="toc-text">2、使用:</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#三、参数解释：spark-shell"><span class="toc-text">三、参数解释：spark-shell</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#SparkUI"><span class="toc-text">SparkUI</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1、SparkUI-界面介绍"><span class="toc-text">1、SparkUI 界面介绍</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Event-logging-is-not-enabled"><span class="toc-text">Event logging is not enabled</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2、配置-historyServer"><span class="toc-text">2、配置 historyServer</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Master-HA"><span class="toc-text">Master HA</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1、Master-的高可用原理"><span class="toc-text">1、Master 的高可用原理</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2、Master-高可用搭建"><span class="toc-text">2、Master 高可用搭建</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-6-0-Spark-Master-at-spark-192-168-198-128-7077"><span class="toc-text">img 1.6.0 Spark Master at spark://192.168.198.128:7077</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-6-0-Spark-Master-at-spark-192-168-198-130-7077"><span class="toc-text">img 1.6.0 Spark Master at spark://192.168.198.130:7077</span></a></li></ol></li></ol></li></ol>
        
    </div>
    <style>
        .left-col .switch-btn,
        .left-col .switch-area {
            display: none;
        }
        .toc-level-3 i,
        .toc-level-3 ol {
            display: none !important;
        }
    </style>

    <input type="button" id="tocButton" value="隐藏目录" title="点击按钮隐藏或者显示文章目录">

    <script>
        yiliaConfig.toc = ["隐藏目录", "显示目录", !!"false"];
    </script>



    
<div class="share">
    
        <div class="bdsharebuttonbox">
            <a href="#" class="fa fa-twitter bds_twi" data-cmd="twi" title="分享到推特"></a>
            <a href="#" class="fa fa-weibo bds_tsina" data-cmd="tsina" title="分享到新浪微博"></a>
            <a href="#" class="fa fa-qq bds_sqq" data-cmd="sqq" title="分享给 QQ 好友"></a>
            <a href="#" class="fa fa-files-o bds_copy" data-cmd="copy" title="复制网址"></a>
            <a href="#" class="fa fa fa-envelope-o bds_mail" data-cmd="mail" title="通过邮件分享"></a>
            <a href="#" class="fa fa-weixin bds_weixin" data-cmd="weixin" title="生成文章二维码"></a>
            <a href="#" class="fa fa-share-alt bds_more" data-cmd="more"></a>
        </div>
        <script>
            window._bd_share_config={
                "common":{"bdSnsKey":{},"bdText":"Spark学习（三）　| Sukie山脉　","bdMini":"2","bdMiniList":false,"bdPic":"","bdStyle":"0","bdSize":"24"},"share":{}};with(document)0[(getElementsByTagName('head')[0]||body).appendChild(createElement('script')).src='/static/api/js/share.js?v=89860593.js?cdnversion='+~(-new Date()/36e5)];
        </script>
    

    
</div>







    	


  
     
     




    <div class="scroll" id="post-nav-button">
        
            <a href="/2019/02/19/Spark学习（四）/" title="上一篇: Spark学习（四）">
                <i class="fa fa-angle-left"></i>
            </a>
        

        <a title="文章列表"><i class="fa fa-bars"></i><i class="fa fa-times"></i></a>

        
            <a href="/2019/02/17/Spark学习（二）/" title="下一篇: Spark学习(二)">
                <i class="fa fa-angle-right"></i>
            </a>
        
    </div>

    <ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2019/02/22/Spark学习（六）/">Spark学习（五）</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/02/21/Spark学习（五）/">Spark学习（五）</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/02/19/Spark学习（四）/">Spark学习（四）</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/02/18/Spark学习（三）/">Spark学习（三）</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/02/17/Spark学习（二）/">Spark学习(二)</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/02/16/Spark学习（一）/">Spark学习</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/02/16/Set方法/">Set方法</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/02/16/List方法/">List方法</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/02/16/String方法/">String 方法</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/02/16/Map方法/">Map方法</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/02/16/数组方法 /">数组方法</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/02/16/面试问题总结/">Map方法</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/02/15/Scala学习/">Scala学习</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/02/14/Redis学习/">Redis学习</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/01/29/Storm学习/">Storm学习</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/01/18/Flume学习/">Flume学习</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/01/17/HBase性能优化/">HBase性能优化</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/01/15/HBase学习/">HBase学习</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/01/14/Hive优化/">Hive优化</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/01/12/Nginx入门学习（第一回合）/">Nginx入门学习（一）</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/01/11/Linux网络配置+常用命令学习(第一回合)/">Linux 入门学习（一）</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/01/11/Hive学习/">Hive学习</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/01/11/Linux 入门学习（第二回合）/">Linux 入门学习（二）</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/01/11/Linux系统CentOS 6安装/">Linux系统CentOS 6</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/01/10/Linux系统数据库MySQL安装/">Linux系统数据库MySQL安装</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/01/05/MapReduce学习/">MapReduce学习</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/01/05/大数据思想/">大数据思想</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/01/04/Hadoop2.X/">Hadoop2.X</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/01/03/Yarn学习/">YARN的入门学习</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/01/03/Zookeeper学习/">Zookeeper学习</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/01/03/HDFS学习/">HDFS学习</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/01/02/Nginx学习/">Nginx学习(总)</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/12/28/手动安装maven坐标依赖/">手动安装maven坐标依赖</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/12/28/常用Linux命令的学习（二）/">常用Linux命令的学习（二）</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/12/27/常用Linux命令的学习（一）/">常用Linux命令的学习（一）</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/12/27/常用Linux命令的学习（三）/">常用Linux命令的学习（三）</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/12/20/Nginx入门学习（第二回合）/">Nginx入门学习（二）</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/12/19/hello-world/">Hello World</a></li></ul>




    <script>
        
    </script>


<!--gitment 评论-->

  <div class="comments" id="comments">
  
  <!--汉化-->
    <link rel="stylesheet" href="https://billts.site/extra_css/gitment.css">
  <script src="https://billts.site/js/gitment.js"></script>
  <!--原型-->
  <!--
  <link rel="stylesheet" href="https://imsun.github.io/gitment/style/default.css">
  <script src="https://imsun.github.io/gitment/dist/gitment.browser.js" type="text/javascript"></script>
  -->
  
      <div id="gitmentContainer" style="margin-bottom: -19px;"></div>
     
      <style>
        .gitment-container a {
          border: none;
        }
        .comments {
          margin: 60px 0 0;padding: 0 60px;
        }
      </style>
     
      <script type="text/javascript">
        var gitment = new Gitment({
        id: 'Mon Feb 18 2019 00:00:00 GMT+0800',
        title: 'Spark学习（三）',
        owner: 'sungithup',
        repo: 'sungithup.github.io',
        oauth: {
        client_id: '80107df5bc27be1c1495',
        client_secret: 'c7949e6fc532f63f30f14fe1aff7f4b9c234860e',
        },
        })
        gitment.render('gitmentContainer')
      </script>
  </div>

<!--gitment 评论 end--></div>
      <footer id="footer">
    <div class="outer">
        <div id="footer-info">
            <div class="footer-left">
                <i class="fa fa-copyright"></i> 
                
                2016-2019 Sukie
            </div>
            <div class="footer-right">
                <a href="http://hexo.io/" target="_blank" title="快速、简洁且高效的博客框架">Hexo</a>  Theme <a href="https://github.com/MOxFIVE/hexo-theme-yelee" target="_blank" title="简而不减 Hexo 双栏博客主题  v3.5">Yelee</a> by MOxFIVE <i class="fa fa-heart animated infinite pulse"></i>
            </div>
        </div>
        
            <div class="visit">
                
                    <span id="busuanzi_container_site_pv" style="display:none">
                        <span id="site-visit" title="本站到访数"><i class="fa fa-user" aria-hidden="true"></i><span id="busuanzi_value_site_uv"></span>
                        </span>
                    </span>
                
                
                    <span>| </span>
                
                
                    <span id="busuanzi_container_page_pv" style="display:none">
                        <span id="page-visit" title="本页阅读量"><i class="fa fa-eye animated infinite pulse" aria-hidden="true"></i><span id="busuanzi_value_page_pv"></span>
                        </span>
                    </span>
                
            </div>
        

        <span id="timeDate">载入天数...</span><span id="times">载入时分秒...</span> 
        <script>
        var now = new Date(); 
        function createtime() { 
        var grt= new Date("02/14/2016 12:49:00");//此处修改你的建站时间或者网站上线时间 
        now.setTime(now.getTime()+250); 
        days = (now - grt ) / 1000 / 60 / 60 / 24; dnum = Math.floor(days); 
        hours = (now - grt ) / 1000 / 60 / 60 - (24 * dnum); hnum = Math.floor(hours); 
        if(String(hnum).length ==1 ){hnum = "0" + hnum;} minutes = (now - grt ) / 1000 /60 - (24 * 60 * dnum) - (60 * hnum); 
        mnum = Math.floor(minutes); if(String(mnum).length ==1 ){mnum = "0" + mnum;} 
        seconds = (now - grt ) / 1000 - (24 * 60 * 60 * dnum) - (60 * 60 * hnum) - (60 * mnum); 
        snum = Math.round(seconds); if(String(snum).length ==1 ){snum = "0" + snum;} 
        document.getElementById("timeDate").innerHTML = "本站已安全运行 "+dnum+" 天 "; 
        document.getElementById("times").innerHTML = hnum + " 小时 " + mnum + " 分 " + snum + " 秒"; 
        } 
        setInterval("createtime()",250);
        </script>

    </div>
</footer>
    </div>
    
    <script src="/js/GithubRepoWidget.js"></script>

<script data-main="/js/main.js" src="//cdn.bootcss.com/require.js/2.2.0/require.min.js"></script>

    <script>
        $(document).ready(function() {
            var iPad = window.navigator.userAgent.indexOf('iPad');
            if (iPad > -1 || $(".left-col").css("display") === "none") {
                var bgColorList = ["#9db3f4", "#414141", "#e5a859", "#f5dfc6", "#c084a0", "#847e72", "#cd8390", "#996731"];
                var bgColor = Math.ceil(Math.random() * (bgColorList.length - 1));
                $("body").css({"background-color": bgColorList[bgColor], "background-size": "cover"});
            }
            else {
                var backgroundnum = 5;
                var backgroundimg = "url(/background/bg-x.jpg)".replace(/x/gi, Math.ceil(Math.random() * backgroundnum));
                $("body").css({"background": backgroundimg, "background-attachment": "fixed", "background-size": "cover"});
            }
        })
    </script>





    <script type="text/x-mathjax-config">
MathJax.Hub.Config({
    tex2jax: {
        inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
        processEscapes: true,
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
    }
});

MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i=0; i < all.length; i += 1) {
        all[i].SourceElement().parentNode.className += ' has-jax';                 
    }       
});
</script>

<script src="//cdn.bootcss.com/mathjax/2.6.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>


<div class="scroll" id="scroll">
    <a href="#" title="返回顶部"><i class="fa fa-arrow-up"></i></a>
    <a href="#comments" onclick="load$hide();" title="查看评论"><i class="fa fa-comments-o"></i></a>
    <a href="#footer" title="转到底部"><i class="fa fa-arrow-down"></i></a>
</div>
<script>
    // Open in New Window
    
        var oOpenInNew = {
             github: ".github-widget a", 
            
            
            
            
            
             archives: ".archive-article-title", 
             miniArchives: "a.post-list-link", 
            
             friends: "#js-friends a", 
             socail: ".social a" 
        }
        for (var x in oOpenInNew) {
            $(oOpenInNew[x]).attr("target", "_blank");
        }
    
</script>

    <script>
        var originTitle = document.title;
        var titleTime;
        document.addEventListener("visibilitychange", function() {
            if (document.hidden) {
                document.title = "(つェ⊂) 我藏好了哦~ " + originTitle;
                clearTimeout(titleTime);
            }
            else {
                document.title = "(*´∇｀*) 被你发现啦~ " + originTitle;
                titleTime = setTimeout(function() {
                    document.title = originTitle;
                }, 2000);
            }
        })
    </script>

<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js">
</script>
<script typr="text/javascript" src="/resources/love.js"></script>
<script typr="text/javascript" src="/resources/float.js"></script>
<script typr="text/javascript" src="/resources/typewriter.js"></script>
<script typr="text/javascript" color="1,104,183" opacity="1" zindex="-1" count50="" src="/resources/particle.js"></script>
  </div>
</body>
</html>